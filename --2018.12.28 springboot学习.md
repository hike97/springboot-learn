**--2018.12.28 springbootå­¦ä¹ **

### ä¸€ã€springboot-Helloworldå…¥é—¨

#####ç¬¬ä¸€ä¸ªæ³¨è§£ï¼š@SpringBootApplication springboot ä¸»é…ç½®ç±» 

```java

å…·ä½“å¦‚ä¸‹ï¼š
@Â·Â·Â·Â·Â·
@SpringBootConfiguration //è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªspringbootçš„é…ç½®ç±»
@EnableAutoConfiguration
@ComponentScan(excludeFilters = {
		@Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),
		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) })
public @interface SpringBootApplication {```}
```

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Configuration //é…ç½®ç±»ä¸Šæ¥æ ‡æ³¨è¿™ä¸ªæ³¨è§£ï¼›è¡¨ç¤ºé…ç½®ç±»--é…ç½®æ–‡ä»¶
public @interface SpringBootConfiguration {

}
```

é…ç½®ç±»ä¹Ÿæ˜¯ä¸€ä¸ªç»„ä»¶@component

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Component//spring ç»„ä»¶
public @interface Configuration {

```

##### ç¬¬äºŒä¸ªæ³¨è§£ï¼š@EnableAutoConfiguration ï¼šå¼€å¯è‡ªåŠ¨é…ç½®åŠŸèƒ½

ä¸¤ä¸ªç»„åˆæ³¨è§£

***â… .@autoconfigurationPackage*** 

```java
@AutoConfigurationPackage
@Import(AutoConfigurationImportSelector.class)
public @interface EnableAutoConfiguration {
```

1).@AutoConfigurationPackageè‡ªåŠ¨é…ç½®åŒ… é‡Œé¢æœ‰ä¸€ä¸ª	import  	

```java
@Documented
@Inherited
@Import(AutoConfigurationPackages.Registrar.class)
public @interface AutoConfigurationPackage {
//@importç»™å®¹å™¨ä¸­å€’å…¥ä¸€ä¸ªç»„ä»¶,ç”±XXX.classå†³å®š
}

```

2ï¼‰.æ‰“å¼€Registrar.classç±» é‡Œé¢æœ‰ä¸€ä¸ªæ–¹æ³•å¯¼å…¥å…ƒæ•°æ®

```java
@Override
public void registerBeanDefinitions(AnnotationMetadata metadata,BeanDefinitionRegistry registry) {
			register(registry, new PackageImport(metadata).getPackageName());
		}
```

![1545965543454](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1545965543454.png)

debugæ¨¡å¼ä¸‹è·å–å…ƒæ•°æ®ä¿¡æ¯ï¼šannotations æ˜¯springbootApplication

introspectedClassï¼ˆå†…çœç±»ï¼‰ è‡ªå·±å‘½åçš„å¯åŠ¨ç±»

![1545966066536](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1545966066536.png)

è¿›è¡Œè®¡ç®—å¾—åˆ°ä½ å®šä¹‰çš„åŒ…å

![1545966144272](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1545966144272.png)

ç»¼ä¸Šæ‰€è¿°ï¼Œ@autoconfigurationçš„ä½œç”¨å°±æ˜¯

**å°†ä¸»é…ç½®ç±»ï¼ˆ@springbootApplicationæ ‡æ³¨çš„ç±»ï¼‰çš„åŒ…åŠä¸‹é¢æ‰€æœ‰ç»„ä»¶æ‰«æåˆ°springå®¹å™¨**

***â…¡ã€@Import(AutoConfigurationImportSelector.class)***

`ç»™å®¹å™¨ä¸­å¯¼å…¥ç»„ä»¶ :AutoConfigurationImportSelector.class ä¸­æœ‰ä¸€ä¸ªselectImportsæ–¹æ³•`

```java
//å°†æ‰€éœ€è¦çš„å¯¼å…¥çš„ç»„ä»¶ä»¥å…¨ç±»åçš„æ–¹å¼è¿”å›ï¼›è¿™äº›ç»„ä»¶å°±ä¼šè¢«æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼›
//ä¼šç»™å®¹å™¨ä¸­å¯¼å…¥éå¸¸å¤šçš„è‡ªåŠ¨é…ç½®ç±»ï¼ˆxxxAutoConfigurationï¼‰ï¼›
//ç»™å®¹å™¨ä¸­å¯¼å…¥è¿™ä¸ªåœºæ™¯æ‰€éœ€è¦çš„æ‰€æœ‰ç»„ä»¶ï¼Œå¹¶é…ç½®å¥½è¿™äº›ç»„ä»¶ï¼›
@Override
public String[] selectImports(AnnotationMetadata annotationMetadata) {
		if (!isEnabled(annotationMetadata)) {
			return NO_IMPORTS;
		}
		AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader
				.loadMetadata(this.beanClassLoader);
		AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(
				autoConfigurationMetadata, annotationMetadata);
		return StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());
	}
```

web-starteréœ€è¦çš„21ä¸ªç»„ä»¶

```java
0 = "org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration"
1 = "org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration"
2 = "org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration"
3 = "org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration"
4 = "org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration"
5 = "org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration"
6 = "org.springframework.boot.autoconfigure.http.codec.CodecsAutoConfiguration"
7 = "org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration"
8 = "org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration"
9 = "org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration"
10 = "org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration"
11 = "org.springframework.boot.autoconfigure.task.TaskSchedulingAutoConfiguration"
12 = "org.springframework.boot.autoconfigure.validation.ValidationAutoConfiguration"
13 = "org.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration"
14 = "org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration"
15 = "org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration"
16 = "org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration"
17 = "org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration"
18 = "org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration"
19 = "org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration"
20 = "org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration"
21 = "org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration"
```

æœ‰äº†è‡ªåŠ¨é…ç½®ç±»ï¼Œå…å»æ‰‹åŠ¨ç¼–å†™æ³¨å…¥åŠŸèƒ½ç»„ä»¶ å¦‚ä½•é…ç½®ï¼Ÿ

**æ–¹æ³•è·Ÿè¸ª  getAutoConfigurationEntry()**ğŸ‘‡

```java
@Override
	public String[] selectImports(AnnotationMetadata annotationMetadata) {
		//Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·
		AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(
				autoConfigurationMetadata, annotationMetadata);
        //~~~~~~~~~~~~
	}
```

**ä¸­æœ‰ä»¥ä¸‹ä»£ç ï¼š**ğŸ‘‡loadFactoryNames(EnableAutoConfiguration.class,this.beanClassLoader)

```java
List<String> configurations = SpringFactoriesLoader.loadFactoryNames(
				getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader());
```

**ä¸­æœ‰ä¸¤ä¸ªå‚æ•°ï¼š**ğŸ‘‡

```java
//1.EnableAutoConfiguration.class
protected Class<?> getSpringFactoriesLoaderFactoryClass() {
		return EnableAutoConfiguration.class;
}
//2.ç±»åŠ è½½å™¨ this.beanClassLoader
protected ClassLoader getBeanClassLoader() {
		return this.beanClassLoader;
}
```

ä¸‹é¢çœ‹ä¸€ä¸‹loadFactoryNames()æ–¹æ³•

```java
public static List<String> loadFactoryNames(Class<?> factoryClass, @Nullable ClassLoader classLoader) {
    String factoryClassName = factoryClass.getName();
return loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());
}
ğŸ‘‡
/**
loadSpringFactoriesæ–¹æ³•
*/
	private static Map<String, List<String>> loadSpringFactories(@Nullable ClassLoader classLoader) {
		MultiValueMap<String, String> result = cache.get(classLoader);
		if (result != null) {
			return result;
		}

		try {
			Enumeration<URL> urls = (classLoader != null ?
					classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :
					ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));
            //````çœç•¥åç»­ä»£ç 
//æ‰“å¼€FACTORIES_RESOURCE_LOCATION
public static final String FACTORIES_RESOURCE_LOCATION = "META-INF/spring.factories";
/**æ ¹æ®è·¯å¾„æ‰¾åˆ°spring.factoriesæ–‡ä»¶
```

![1545983078141](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1545983078141.png)

![1545983114885](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1545983114885.png)

ç»¼ä¸Šæ‰€è¿°ï¼šspringboot åœ¨å¯åŠ¨çš„æ—¶å€™ä»ç±»è·¯å¾„ä¸‹çš„META-INF/spring.factoriesä¸­è·å–

EnableAutoConfigurationæŒ‡å®šçš„å€¼å¹¶ä½œä¸ºè‡ªåŠ¨é…ç½®ç±»å¯¼å…¥å®¹å™¨ä¸­ï¼Œè¿›è¡Œè‡ªåŠ¨é…ç½®å·¥ä½œã€‚

**ä¾‹å¦‚ï¼šWebMvcAutoConfigurationä¸­çš„ä¸€äº›é…ç½®**ï¼šğŸ‘‡

```java
package org.springframework.boot.autoconfigure.web.servlet;
//resté£æ ¼ä¸­çš„æ–¹æ³•è¿‡æ»¤å™¨
@Bean
@ConditionalOnMissingBean(HiddenHttpMethodFilter.class)
@ConditionalOnProperty(prefix = "spring.mvc.hiddenmethod.filter", name = "enabled", matchIfMissing = true)
public OrderedHiddenHttpMethodFilter hiddenHttpMethodFilter() {
    return new OrderedHiddenHttpMethodFilter();
}
//è§†å›¾è§£æå™¨
@Bean
@ConditionalOnBean(ViewResolver.class)
@ConditionalOnMissingBean(name = "viewResolver", value = ContentNegotiatingViewResolver.class)
public ContentNegotiatingViewResolver viewResolver(BeanFactory beanFactory) {
			ContentNegotiatingViewResolver resolver = new ContentNegotiatingViewResolver();
			resolver.setContentNegotiationManager(
					beanFactory.getBean(ContentNegotiationManager.class));
			// ContentNegotiatingViewResolver uses all the other view resolvers to locate
			// a view so it should have a high precedence
			resolver.setOrder(Ordered.HIGHEST_PRECEDENCE);
			return resolver;
}
```

```tex
å°ç»“ï¼šä¸‰ä¸ªæ³¨è§£
@SpringBootConfiguration å®é™…ä¸Šæ˜¯@configuration å®é™…ä¸Šæ˜¯ä¸€ä¸ªcomponent-->é…ç½®ç±»
@EnableAutoConfiguration
	@AutoConfigurationPackage() ğŸ‘‰@Import(AutoConfigurationPackages.Registrar.class)-->å®šä½é…ç½®åŒ…,åŠ è½½ç”¨æˆ·å†™çš„ç»„ä»¶
	
    @Import(AutoConfigurationImportSelector.class)-->è‡ªåŠ¨è£…é…é»˜è®¤ç»„ä»¶
javaEE æ•´ä½“æ•´åˆè§£å†³æ–¹æ¡ˆå’Œè‡ªåŠ¨é…ç½®éƒ½åœ¨spring-boot-autoconfigure:X.X.XRELEASEä¸­
```

### **äºŒã€springbootMVCè‡ªåŠ¨é…ç½®åŠæ‹“å±•åŸç†**

å®˜æ–¹æ–‡æ¡£

https://docs.spring.io/spring-boot/docs/2.1.1.RELEASE/reference/htmlsingle/#boot-features-developing-web-applications

### 28.1.1 Spring MVC Auto-configuration

Spring Boot provides auto-configuration for Spring MVC that works well with most applications.

The auto-configuration adds the following features on top of Springâ€™s defaults:

- Inclusion of `ContentNegotiatingViewResolver` and `BeanNameViewResolver` beans.

  - è‡ªåŠ¨é…ç½®äº†ViewResolverï¼ˆè§†å›¾è§£æå™¨ï¼šæ ¹æ®æ–¹æ³•çš„è¿”å›å€¼å¾—åˆ°è§†å›¾å¯¹è±¡ï¼ˆViewï¼‰ï¼Œè§†å›¾å¯¹è±¡å†³å®šå¦‚ä½•æ¸²æŸ“ï¼ˆè½¬å‘ï¼Ÿé‡å®šå‘ï¼Ÿï¼‰ï¼‰

  - ```java
    @Bean
    @ConditionalOnBean(ViewResolver.class)
    @ConditionalOnMissingBean(name = "viewResolver", value = ContentNegotiatingViewResolver.class)
    public ContentNegotiatingViewResolver viewResolver(BeanFactory beanFactory) {
    ContentNegotiatingViewResolver resolver = new ContentNegotiatingViewResolver();
    resolver.setContentNegotiationManager(					beanFactory.getBean(ContentNegotiationManager.class));
    resolver.setOrder(Ordered.HIGHEST_PRECEDENCE);
    return resolver    
    }
    ğŸ‘‡
    ```

  - ```java
    //ContentNegotiatingViewResolverä¸­çš„resolveViewNameï¼ˆï¼‰æ–¹æ³•
    @Override
    @Nullable
    public View resolveViewName(String viewName, Locale locale) throws Exception {
    		//~~~~~çœç•¥~~~~~~~
    		if (requestedMediaTypes != null) {
                //ç¬¬ä¸€æ­¥ï¼šè·å–å¤‡é€‰è§†å›¾å¯¹è±¡
    			List<View> candidateViews = getCandidateViews(viewName, locale, requestedMediaTypes);
                //ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æœ€é€‚åˆçš„è§†å›¾å¯¹è±¡
    			View bestView = getBestView(candidateViews, requestedMediaTypes, attrs);
    			if (bestView != null) {
    				return bestView;
    			}
    		}
    		//~~~~~çœç•¥~~~~~~~
    	}
    /*è¿›å…¥getCandidateViewsï¼ˆï¼‰æ–¹æ³•*/
    
    ```

  - ```java
    /**
      *	ä½œç”¨ï¼šç»„åˆæ‰€æœ‰è§†å›¾è§£æå™¨ å…³é”®å­—this.viewResolver
      */
    private List<View> getCandidateViews(String viewName, Locale locale, List<MediaType> requestedMediaTypes)
    			throws Exception {
    		List<View> candidateViews = new ArrayList<>();
    		if (this.viewResolvers != null) {
    			for (ViewResolver viewResolver : this.viewResolvers) {
    				View view = viewResolver.resolveViewName(viewName, locale);
    				if (view != null) {
    					candidateViews.add(view);
    				}
    		/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~çœç•¥~~~~~~~~~~~~~~~~*/
    		return candidateViews;
    	}
    ```

  - ```java
    /**
      åˆå§‹åŒ–æ–¹æ³•ï¼Œå®¹å™¨å·¥å‚ç±»è·å–æ‰€æœ‰çš„è§†å›¾è§£æå™¨
    */
    @Override
    protected void initServletContext(ServletContext servletContext) {
    Collection<ViewResolver> matchingBeans =				BeanFactoryUtils.beansOfTypeIncludingAncestors(obtainApplicationContext(),ViewResolver.class).values();
     /*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~çœç•¥~~~~~~~~~~~~~~~~*/   
    }
    ```

  - å¦‚ä½•å®šåˆ¶ï¼šæˆ‘ä»¬å¯ä»¥è‡ªå·±ç»™å®¹å™¨ä¸­æ·»åŠ ä¸€ä¸ªè§†å›¾è§£æå™¨

  - ```java
    /**åœ¨é…ç½®ç±»ä¸‹æ³¨å…¥ä¸€ä¸ªè§†å›¾è§£æå™¨*/
    @SpringBootApplication
    public class SpringbootLearnApplication {
    
    	public static void main(String[] args) {
    		SpringApplication.run(SpringbootLearnApplication.class, args);
    	}
    
    	@Bean
    	public ViewResolver myViewResolver(){
    		return new MyViewResolver ();
    	}
    
    	public static class MyViewResolver implements ViewResolver{
    
    		@Nullable
    		@Override
    		public View resolveViewName (String viewName, Locale locale) throws Exception {
    			return null;
    		}
    	}
    }
    
    ```

  - å¼€å¯debugæ¨¡å¼ï¼šä½ç½®ï¼šdispatcherServletçš„doDispatch()æ–¹æ³•

  - ![1546064214598](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546064214598.png)

  - ![1546064391924](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546064391924.png)

  - å‘ç°ç¡®å®æ³¨å…¥äº†è‡ªå®šä¹‰çš„è§†å›¾è§£æå™¨

- Support for serving static resources, including support for WebJars (covered [later in this document](https://docs.spring.io/spring-boot/docs/2.1.1.RELEASE/reference/htmlsingle/#boot-features-spring-mvc-static-content))).

  - é™æ€èµ„æºæ–‡ä»¶å¤¹è·¯å¾„ï¼Œwebjars

- Automatic registration of `Converter`, `GenericConverter`, and `Formatter` beans.

  - Converterâ¡è½¬æ¢å™¨ï¼šå°†é¡µé¢æäº¤çš„æ–‡æœ¬è½¬æ¢æˆå®ä½“ç±»çš„ç›¸å…³å±æ€§

  - Formatterâ¡æ ¼å¼åŒ–å™¨ï¼š2017/12/17===Dateï¼›

  - ```java
    @Bean
    @Override
    public FormattingConversionService mvcConversionService() {
        WebConversionService conversionService = new WebConversionService(
            this.mvcProperties.getDateFormat());
        addFormatters(conversionService);
        return conversionService;
    }
    //è‡ªå·±æ·»åŠ çš„æ ¼å¼åŒ–è½¬æ¢å™¨ï¼Œæˆ‘ä»¬åªéœ€æ”¾åœ¨å®¹å™¨ä¸­å³å¯ ğŸ‘‡
    ```

  - ```java
    @Override
    public void addFormatters(FormatterRegistry registry) {
        for (Converter<?, ?> converter : getBeansOfType(Converter.class)) {
            registry.addConverter(converter);
        }
        for (GenericConverter converter : getBeansOfType(GenericConverter.class)) {
            registry.addConverter(converter);
        }
        for (Formatter<?> formatter : getBeansOfType(Formatter.class)) {
            registry.addFormatter(formatter);
        }
    }
    ```

  - 

- Support for `HttpMessageConverters` (covered [later in this document](https://docs.spring.io/spring-boot/docs/2.1.1.RELEASE/reference/htmlsingle/#boot-features-spring-mvc-message-converters)).

  - springmvc ç”¨æ¥è½¬æ¢Httpè¯·æ±‚å’Œå“åº”çš„ï¼›User-json
  - messageConvertersä»å®¹å™¨ä¸­ç¡®å®šï¼šè·å–æ‰€æœ‰çš„HttpMessageConverters`;
  - è‡ªå·±ç»™å®¹å™¨ä¸­æ·»åŠ HttpMessageConverter,åªéœ€å°†è‡ªå·±çš„ç»„ä»¶æ³¨å†Œå®¹å™¨ä¸­
  - ï¼ˆ@Bean,@Componentï¼‰

- Automatic registration of `MessageCodesResolver` (covered [later in this document](https://docs.spring.io/spring-boot/docs/2.1.1.RELEASE/reference/htmlsingle/#boot-features-spring-message-codes)).

  - ```java
    @Override
    public MessageCodesResolver getMessageCodesResolver() {
        if (this.mvcProperties.getMessageCodesResolverFormat() != null) {
            DefaultMessageCodesResolver resolver = new DefaultMessageCodesResolver();
            resolver.setMessageCodeFormatter(
                this.mvcProperties.getMessageCodesResolverFormat());
            return resolver;
        }
        return null;
    }
    è¿›å…¥getMessageCodesResolverFormat()æ–¹æ³•ğŸ‘‡
    ```

  - ```java
    public DefaultMessageCodesResolver.Format getMessageCodesResolverFormat() {
        return this.messageCodesResolverFormat;
    }
    ç‚¹å‡»FormatğŸ‘‡
    ```

  - ```java
    public enum Format implements MessageCodeFormatter {
    
    		/**
    		 * Prefix the error code at the beginning of the generated message code. e.g.:
    		 * {@code errorCode + "." + object name + "." + field}
    		 */
    		PREFIX_ERROR_CODE {
    			@Override
    			public String format(String errorCode, @Nullable String objectName, @Nullable String field) {
    				return toDelimitedString(errorCode, objectName, field);
    			}
    		},
    
    		/**
    		 * Postfix the error code at the end of the generated message code. e.g.:
    		 * {@code object name + "." + field + "." + errorCode}
    		 */
    		POSTFIX_ERROR_CODE {
    			@Override
    			public String format(String errorCode, @Nullable String objectName, @Nullable String field) {
    				return toDelimitedString(objectName, field, errorCode);
    			}
    		};
    
    ```

  - å¯è§MessageCodesResolverç”¨äºç”Ÿæˆé”™è¯¯ä»£ç ç”Ÿæˆè§„åˆ™çš„

- Static `index.html` support. é™æ€é¦–é¡µè®¿é—®

- Custom `Favicon` support (covered [later in this document](https://docs.spring.io/spring-boot/docs/2.1.1.RELEASE/reference/htmlsingle/#boot-features-spring-mvc-favicon)).

- Automatic use of a `ConfigurableWebBindingInitializer` bean (covered [later in this document](https://docs.spring.io/spring-boot/docs/2.1.1.RELEASE/reference/htmlsingle/#boot-features-spring-mvc-web-binding-initializer)).

  - ```java
    @Override
    protected ConfigurableWebBindingInitializer getConfigurableWebBindingInitializer() {
        try {
            //ç”±æ­¤ä»£ç å¯è§ï¼šæˆ‘ä»¬å¯ä»¥é…ç½®ä¸€ä¸ªConfigurableWebBindingInitializeræ¥æ›¿æ¢é»˜è®¤çš„ï¼›
            return           this.beanFactory.getBean(ConfigurableWebBindingInitializer.class);
        }
        catch (NoSuchBeanDefinitionException ex) {
            //å¦‚æœæ‰¾ä¸åˆ°ä¼šè°ƒç”¨çˆ¶ç±»æ–¹æ³•ğŸ‘‡
            return super.getConfigurableWebBindingInitializer();
        }
    }
    ```

  - ```java
    /**
    	 * Return the {@link ConfigurableWebBindingInitializer} to use for
    	 * initializing all {@link WebDataBinder} instances.
    	 åˆå§‹åŒ–webç»‘å®šæ•°æ®çš„å®ä¾‹
    	 */
    protected ConfigurableWebBindingInitializer getConfigurableWebBindingInitializer() {
        ConfigurableWebBindingInitializer initializer = new ConfigurableWebBindingInitializer();
        initializer.setConversionService(mvcConversionService());
        initializer.setValidator(mvcValidator());
        MessageCodesResolver messageCodesResolver = getMessageCodesResolver();
        if (messageCodesResolver != null) {
            initializer.setMessageCodesResolver(messageCodesResolver);
        }
        return initializer;
    }
    ```

  - webDataBinderçš„ä½œç”¨ï¼šè¯·æ±‚æ•°æ®è½¬æ¢ä¸ºjavaBean;

**If you want to keep Spring Boot MVC features and you want to add additional MVC configuration (interceptors, formatters, view controllers, and other features), you can add your own `@Configuration` class of type `WebMvcConfigurer` but without `@EnableWebMvc`.** 

If you wish to provide custom instances of `RequestMappingHandlerMapping`, `RequestMappingHandlerAdapter`, or `ExceptionHandlerExceptionResolver`, you can declare a `WebMvcRegistrationsAdapter` instance to provide such components.

If you want to take complete control of Spring MVC, you can add your own `@Configuration` annotated with `@EnableWebMvc`.

##### æ‹“å±•springmvc:æ—¢ä¿ç•™äº†åŸæ¥çš„é…ç½® ä¹Ÿç”¨äºæˆ‘ä»¬æ‹“å±•çš„é…ç½®

```java
@Configuration
public class MyMvcConfig implements WebMvcConfigurer {

    @Override
    public void addViewControllers (ViewControllerRegistry registry) {
        registry.addViewController ("/hello").setViewName ("success");

    }
}

```

åŸç†ï¼šä¸ºä»€ä¹ˆèƒ½æ‹“å±•ï¼Ÿ

1ï¼‰ã€WebMvcAutoConfigurationæ˜¯SpringMVCçš„è‡ªåŠ¨é…ç½®ç±»

```java
/**
	è¯¥ç±»ä¸­æœ‰ä¸€ä¸ªé™æ€ç±»WebMvcAutoConfigurationAdapter
	--æ³¨æ„ä¸WebMvcConfigurerAdapterï¼ˆ2.Xå·²ç»åºŸå¼ƒï¼‰çš„åŒºåˆ«
	æ­¤ç±»ä¹Ÿæ˜¯å®ç°äº†webMVcConfigerï¼Œè¿›è¡Œäº†webmvcæ–¹æ³•çš„è‡ªåŠ¨è£…é…ï¼Œ
	è¿™ä¸æ˜¯é‡ç‚¹ï¼Œæˆ‘ä»¬æ¥æŸ¥çœ‹Importçš„ç±»ï¼šEnableWebMvcConfiguration.class
*/
@Configuration
@Import(EnableWebMvcConfiguration.class)
@EnableConfigurationProperties({ WebMvcProperties.class, ResourceProperties.class })
@Order(0)
public static class WebMvcAutoConfigurationAdapter
    implements WebMvcConfigurer, ResourceLoaderAware {
/*ç»§æ‰¿äº†DelegatingWebMvcConfiguration*/
@Configuration
public static class EnableWebMvcConfiguration extends DelegatingWebMvcConfiguration {
ğŸ‘‡
```

```java
//è¯¥ç±»ä¸­æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š
//Autowiredæ ‡æ³¨åœ¨æ–¹æ³•ä¸Šå°±æ„å‘³ç€ï¼šä»å®¹å™¨ä¸­è·å–æ‰€æœ‰çš„WebMvcConfigurer 
private final WebMvcConfigurerComposite configurers = new WebMvcConfigurerComposite();
@Autowired(required = false)
public void setConfigurers(List<WebMvcConfigurer> configurers) {
    if (!CollectionUtils.isEmpty(configurers)) {
        //èµ‹å€¼åˆ°configuresä¸­
        this.configurers.addWebMvcConfigurers(configurers);
    }
}
// ç‚¹è¿› ï¼ˆconfigurersï¼‰ç±»
```

```java
class WebMvcConfigurerComposite implements WebMvcConfigurer {
private final List<WebMvcConfigurer> delegates = new ArrayList<>();
    //ä¸€ä¸ªå‚è€ƒå®ç°ï¼›å°†æ‰€æœ‰çš„WebMvcConfigurerç›¸å…³é…ç½®éƒ½æ¥ä¸€èµ·è°ƒç”¨ï¼›
    @Override
    public void addViewControllers(ViewControllerRegistry registry) {
        for (WebMvcConfigurer delegate : this.delegates) {
            delegate.addViewControllers(registry);
        }
    }
    3ï¼‰ã€å®¹å™¨ä¸­æ‰€æœ‰çš„WebMvcConfigureréƒ½ä¼šä¸€èµ·èµ·ä½œç”¨ï¼›
    4ï¼‰ã€æˆ‘ä»¬çš„é…ç½®ç±»ä¹Ÿä¼šè¢«è°ƒç”¨ï¼›
    æ•ˆæœï¼šSpringMVCçš„è‡ªåŠ¨é…ç½®å’Œæˆ‘ä»¬çš„æ‰©å±•é…ç½®éƒ½ä¼šèµ·ä½œç”¨ï¼›	
```

##### 3ã€å…¨é¢æ¥ç®¡SpringMVCï¼›

SpringBootå¯¹SpringMVCçš„è‡ªåŠ¨é…ç½®ä¸éœ€è¦äº†ï¼Œæ‰€æœ‰éƒ½æ˜¯æˆ‘ä»¬è‡ªå·±é…ç½®ï¼›æ‰€æœ‰çš„SpringMVCçš„è‡ªåŠ¨é…ç½®éƒ½å¤±æ•ˆäº†
æˆ‘ä»¬éœ€è¦åœ¨é…ç½®ç±»ä¸­æ·»åŠ @EnableWebMvcå³å¯ï¼›

**ä¸ºä»€ä¹ˆå…¨é¢æ¥ç®¡ï¼Œè‡ªåŠ¨é…ç½®ä¼šå¤±æ•ˆï¼Ÿ**

```java
@Import(DelegatingWebMvcConfiguration.class)
public @interface EnableWebMvc {
}
```

```java
@Configuration
public class DelegatingWebMvcConfiguration extends WebMvcConfigurationSupport {

```

```java
@Configuration
@ConditionalOnWebApplication(type = Type.SERVLET)
@ConditionalOnClass({ Servlet.class, DispatcherServlet.class, WebMvcConfigurer.class })
//å®¹å™¨ä¸­æ²¡æœ‰è¿™ä¸ªç»„ä»¶çš„æ—¶å€™ï¼Œè¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»æ‰ç”Ÿæ•ˆ
//é…ç½®äº†EnableWebMvcä¼šå¯¼å…¥ DelegatingWebMvcConfiguration ä»–æ˜¯å±äºã€WebMvcConfigurationSupport.classã€‘èŒƒç•´çš„ æ‰€ä»¥è‡ªåŠ¨é…ç½®å¤±æ•ˆ
@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)
@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE + 10)
@AutoConfigureAfter({ DispatcherServletAutoConfiguration.class,
		TaskExecutionAutoConfiguration.class, ValidationAutoConfiguration.class })
public class WebMvcAutoConfiguration {
```

**ç»¼ä¸Šæ‰€è¿°**ï¼Œ@EnableWebMvcå°†WebMvcConfigurationSupportç»„ä»¶å¯¼å…¥è¿›æ¥ï¼Œå¯¼å…¥çš„WebMvcConfigurationSupportåªæ˜¯SpringMVCæœ€åŸºæœ¬çš„åŠŸèƒ½ï¼›

### ä¸‰ã€å¦‚ä½•ä¿®æ”¹SpringBootçš„é»˜è®¤é…ç½®

æ¨¡å¼ï¼š

â€‹	1ï¼‰ã€SpringBootåœ¨è‡ªåŠ¨é…ç½®å¾ˆå¤šç»„ä»¶çš„æ—¶å€™ï¼Œå…ˆçœ‹å®¹å™¨ä¸­æœ‰æ²¡æœ‰ç”¨æˆ·è‡ªå·±é…ç½®çš„ï¼ˆ@Bean @Componentï¼‰å¦‚æœæœ‰å°±ç”¨ç”¨æˆ·é…ç½®çš„ï¼Œå¦‚æœæ²¡æœ‰ï¼Œæ‰è‡ªåŠ¨é…ç½®ï¼›å¦‚æœæœ‰äº›ç»„ä»¶å¯ä»¥æœ‰å¤šä¸ªï¼ˆViewResolverï¼‰å°†ç”¨æˆ·é…ç½®çš„å’Œè‡ªå·±é»˜è®¤çš„ç»„åˆèµ·æ¥ï¼›
â€‹	2ï¼‰ã€åœ¨SpringBootä¸­ä¼šæœ‰éå¸¸å¤šçš„xxxConfigurerå¸®åŠ©æˆ‘ä»¬è¿›è¡Œæ‰©å±•é…ç½®
â€‹	3ï¼‰ã€åœ¨SpringBootä¸­ä¼šæœ‰å¾ˆå¤šçš„xxxCustomizerå¸®åŠ©æˆ‘ä»¬è¿›è¡Œå®šåˆ¶é…ç½®ï¼‰



### å››ã€springbootçš„å¯åŠ¨è¿è¡Œæµç¨‹

â… .å¯åŠ¨æµç¨‹ï¼šDEBUG--SpringApplication.runæ–¹æ³•

![1546175409191](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546175409191.png)

![1546175470920](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546175470920.png)

1ã€åˆ›å»ºspringApplicationå¯¹è±¡

â€‹	//runæ–¹æ³• æ‰§è¡Œäº†SpringApplication()çš„æœ‰å‚æ„é€ å¯¹è±¡çš„runæ–¹æ³•æ–¹æ³•è·Ÿè¸ªå¦‚ä¸‹ï¼š

```java
public SpringApplication(Class<?>... primarySources) {
    this(null, primarySources);
}

```

```java
public SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources) {
    this.resourceLoader = resourceLoader;
    Assert.notNull(primarySources, "PrimarySources must not be null");
    //1.å…ˆå°†ä¸»é…ç½®ç±»ä¸­æ·»åŠ åˆ°primarySourceä¸­
    this.primarySources = new LinkedHashSet<>(Arrays.asList(primarySources));
    //2.å†³å®šwebåº”ç”¨ç¯å¢ƒ å› ä¸ºspringboot 2.X åŠ å…¥äº†reactç¼–ç¨‹
    this.webApplicationType = WebApplicationType.deduceFromClasspath();
    //3.ä»ç±»è·¯å¾„ä¸‹æ‰¾åˆ°METAâ€INF/spring.factoriesé…ç½®çš„æ‰€æœ‰ApplicationContextInitializerï¼›ç„¶åä¿å­˜èµ·æ¥
    setInitializers((Collection) getSpringFactoriesInstances(
        ApplicationContextInitializer.class));
    //4.ä»ç±»è·¯å¾„ä¸‹æ‰¾åˆ°METAâ€INF/spring.factoriesé…ç½®çš„æ‰€æœ‰ApplicationListenerï¼›ç„¶åä¿å­˜èµ·æ¥
    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));
    //5.ä»å¤šä¸ªé…ç½®ç±»ä¸­æ‰¾åˆ°æœ‰mainæ–¹æ³•çš„ä¸»é…ç½®ç±»
    this.mainApplicationClass = deduceMainApplicationClass();
}
ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ä»£ç å¦‚ä¸‹ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€ã€
private Class<?> deduceMainApplicationClass() {
		try {
			StackTraceElement[] stackTrace = new RuntimeException().getStackTrace();
			for (StackTraceElement stackTraceElement : stackTrace) {
				if ("main".equals(stackTraceElement.getMethodName())) {
					return Class.forName(stackTraceElement.getClassName());
				}
			}
		}
		catch (ClassNotFoundException ex) {
			// Swallow and continue
		}
		return null;
	}

```

1ï¸âƒ£ã€‚primarysourceæˆªå›¾

![1546176946891](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546176946891.png)

2ï¸âƒ£ã€‚webApplicationType

![1546177192932](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546177192932.png)

3ï¸âƒ£ã€‚this.initiallizers

![1546224270712](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546224270712.png)

4ï¸âƒ£ã€‚this.listener

![1546224690354](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546224690354.png)

2ã€è¿è¡Œrunæ–¹æ³•

```txt
ä¸€ï¼šç¯å¢ƒå‡†å¤‡
äºŒï¼šåˆ›å»ºIOCå®¹å™¨
```



**å‡ ä¸ªé‡è¦çš„äº‹ä»¶å›è°ƒæœºåˆ¶**
**é…ç½®åœ¨META-INF/spring.factories**
ApplicationContextInitializer
SpringApplicationRunListener
**åªéœ€è¦æ”¾åœ¨iocå®¹å™¨ä¸­**
ApplicationRunner
CommandLineRunner

```java
public ConfigurableApplicationContext run(String... args) {
    //1.å¼€å¯åœæ­¢çš„ç›‘å¬
    StopWatch stopWatch = new StopWatch();
    stopWatch.start();
    //2.å£°æ˜iocå®¹å™¨
    ConfigurableApplicationContext context = null;
    Collection<SpringBootExceptionReporter> exceptionReporters = new ArrayList<>();
    //3.awtç›¸å…³é…ç½®
    configureHeadlessProperty();
    //4.è·å–SpringApplicationRunListener;ä»ç±»è·¯å¾„ä¸‹METAâ€INF/spring.factoriesï¼ˆè§è¯¦ç»†åˆ†æï¼‰
   SpringApplicationRunListeners listeners = getRunListeners(args);
    //5.å›è°ƒæ‰€æœ‰çš„è·å–SpringApplicationRunListener.starting()æ–¹æ³•
    listeners.starting();
```

**è¯¦ç»†åˆ†æä¸€ï¼š**è·å–SpringApplicationRunListenerã€‚

```java
private SpringApplicationRunListeners getRunListeners(String[] args) {
    Class<?>[] types = new Class<?>[] { SpringApplication.class, String[].class };
    return new SpringApplicationRunListeners(logger, getSpringFactoriesInstances(
        SpringApplicationRunListener.class, types, this, args));
}
```

![1546506701440](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546506701440.png)

å¦‚ä¸Šå›¾ï¼Œé€šè¿‡åå°„æœºåˆ¶è·å–åˆ°EventPublishingRunListenerçš„å®ä¾‹ï¼ˆMySpringApplicationRunListnerä¸ºæœ¬äººç¼–å†™ ï¼Œå¯å¿½ç•¥ï¼‰

ç„¶åè°ƒç”¨listeners.run()æ–¹æ³•

![1546506986982](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546506986982.png)

```java
å¾ªç¯éå†listenerçš„starting()æ–¹æ³•
```

```java

    try {
        //6.å°è£…å‘½ä»¤è¡Œå‚æ•°
        ApplicationArguments applicationArguments = new DefaultApplicationArguments(
            args);
        //7.å‡†å¤‡ç¯å¢ƒ
        ConfigurableEnvironment environment = prepareEnvironment(listeners,
                                                                 applicationArguments);
        	       
       
```

--prepareEnvirenmentï¼ˆï¼‰æ–¹æ³•

```java
private ConfigurableEnvironment prepareEnvironment(
			SpringApplicationRunListeners listeners,
			ApplicationArguments applicationArguments) {
		// Create and configure the environment
		ConfigurableEnvironment environment = getOrCreateEnvironment();//SERVLET REACT
		//é…ç½®è¿™äº›ç¯å¢ƒ
    	configureEnvironment(environment, applicationArguments.getSourceArgs());
    	//7.1 åˆ›å»ºç¯å¢ƒå®Œæˆåå›è°ƒSpringApplicationRunListener.environmentPrepared()ï¼›è¡¨ç¤ºç¯å¢ƒå‡†å¤‡å®Œæˆ 
		listeners.environmentPrepared(environment);
    	//2.Xå¤šçš„æ–¹æ³•
		bindToSpringApplication(environment);
    	//1.5.6ä¸ºisWebEnvironment å¯èƒ½ç”±äºåŠ å…¥reactçš„åŸå› 
		if (!this.isCustomEnvironment) {
			environment = new EnvironmentConverter(getClassLoader())
					.convertEnvironmentIfNecessary(environment, deduceEnvironmentClass());
		}
		ConfigurationPropertySources.attach(environment);
		return environment;
	}
```

![1546567129686](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546567129686.png)

![1546583567413](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546583567413.png)

```java
		//2.0æ–°å¢
		configureIgnoreBeanInfo(environment);
        //8.æ‰“å°springBootçš„å›¾æ ‡
        Banner printedBanner = printBanner(environment);
        //9.åˆ›å»ºapplicationContextä¸Šä¸‹æ–‡ï¼›
        context = createApplicationContext();
       
```

![1546584587896](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546584587896.png)





```java
 //10.å¼‚å¸¸æŠ¥å‘Š
        exceptionReporters = getSpringFactoriesInstances(
            SpringBootExceptionReporter.class,
            new Class[] { ConfigurableApplicationContext.class }, context);
        //11.å‡†å¤‡ä¸Šä¸‹æ–‡ç¯å¢ƒ;
            //11.1 å°†environmentä¿å­˜åˆ°iocä¸­ï¼›è€Œä¸”applyInitializers()ï¼›
            //11.2 applyInitializers()ï¼šå›è°ƒä¹‹å‰ä¿å­˜çš„æ‰€æœ‰çš„ApplicationContextInitializerçš„initializeæ–¹æ³•
            //11.3 å›è°ƒæ‰€æœ‰çš„SpringApplicationRunListenerçš„contextPrepared()ï¼›
        prepareContext(context, environment, listeners, applicationArguments,
                       printedBanner);
        	//11.4 prepareContextè¿è¡Œå®Œæˆä»¥åå›è°ƒæ‰€æœ‰çš„SpringApplicationRunListenerçš„contextLoadedï¼ˆï¼‰ï¼›
       
```

--prepareContext()æ–¹æ³• ğŸ‘‡

```java
private void prepareContext(ConfigurableApplicationContext context,
                            ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,
                            ApplicationArguments applicationArguments, Banner printedBanner) {
    //ä¿å­˜ä¹‹å‰å‡†å¤‡çš„ç¯å¢ƒ
    context.setEnvironment(environment);
    //iocå®¹å™¨åç½®å¤„ç† æ³¨å†Œå°ç»„ä»¶
    postProcessApplicationContext(context);
    applyInitializers(context);
    //applyInitializersæ–¹æ³•æ‰§è¡Œå®Œï¼Œç›‘å¬å™¨è°ƒç”¨contextPreparedæ–¹æ³•ï¼ˆï¼‰ï¼Œå’Œä¹‹å‰çš„start() prepreparedEnvironment()ä¸€æ ·å¾ªç¯è°ƒç”¨
    listeners.contextPrepared(context);
    if (this.logStartupInfo) {
        logStartupInfo(context.getParent() == null);
        logStartupProfileInfo(context);
    }
    // Add boot specific singleton beans
    ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();
    //æ³¨å†Œå‘½ä»¤è¡Œä¸»ç±»
    beanFactory.registerSingleton("springApplicationArguments", applicationArguments);
    if (printedBanner != null) {
        //banneræ³¨å†Œ
        beanFactory.registerSingleton("springBootBanner", printedBanner);
    }
    if (beanFactory instanceof DefaultListableBeanFactory) {
        ((DefaultListableBeanFactory) beanFactory)
        .setAllowBeanDefinitionOverriding(this.allowBeanDefinitionOverriding);
    }
    // Load the sources
    //è·å–æ‰€æœ‰èµ„æº
    Set<Object> sources = getAllSources();
    Assert.notEmpty(sources, "Sources must not be empty");
    load(context, sources.toArray(new Object[0]));
    //paredContextæ–¹æ³•ï¼Œè¿›è¡Œå®Œæ¯• è°ƒç”¨listenerçš„contextLoadedï¼ˆï¼‰æ–¹æ³•
    listeners.contextLoaded(context);
}
```

--applyInitializers()æ–¹æ³• å°†ä¹‹å‰åˆå§‹åŒ–çš„springApplicatioå¯¹è±¡ä¸­çš„initializersè¿›è¡Œå¾ªç¯éå†å›è°ƒinitializeï¼ˆï¼‰æ–¹æ³•

![1546586855044](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546586855044.png)





```java
 //12.åˆ·æ–°å®¹å™¨ï¼›iocå®¹å™¨åˆå§‹åŒ–ï¼ˆå¦‚æœæ˜¯webåº”ç”¨è¿˜ä¼šåˆ›å»ºåµŒå…¥å¼çš„Tomcatï¼‰ï¼›Springæ³¨è§£ç‰ˆ
        	//æ‰«æï¼Œåˆ›å»ºï¼ŒåŠ è½½æ‰€æœ‰ç»„ä»¶çš„åœ°æ–¹ï¼›
        refreshContext(context);
        ğŸ‘‡
```



--refresh()æ–¹æ³• iocå®¹å™¨åˆå§‹åŒ–

```java
@Override
public void refresh() throws BeansException, IllegalStateException {
    synchronized (this.startupShutdownMonitor) {
        // Prepare this context for refreshing.
        prepareRefresh();

        // Tell the subclass to refresh the internal bean factory.
        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();

        // Prepare the bean factory for use in this context.
        prepareBeanFactory(beanFactory);

        try {
            // Allows post-processing of the bean factory in context subclasses.
            postProcessBeanFactory(beanFactory);

            // Invoke factory processors registered as beans in the context.
            invokeBeanFactoryPostProcessors(beanFactory);

            // Register bean processors that intercept bean creation.
            registerBeanPostProcessors(beanFactory);

            // Initialize message source for this context.
            initMessageSource();

            // Initialize event multicaster for this context.
            initApplicationEventMulticaster();

            // Initialize other special beans in specific context subclasses.
            onRefresh();

            // Check for listener beans and register them.
            registerListeners();

            // Instantiate all remaining (non-lazy-init) singletons.
            //åˆå§‹åŒ–å•å®ä¾‹bean
            finishBeanFactoryInitialization(beanFactory);

            // Last step: publish corresponding event.
            finishRefresh();
        }

        catch (BeansException ex) {
            if (logger.isWarnEnabled()) {
                logger.warn("Exception encountered during context initialization - " +
                            "cancelling refresh attempt: " + ex);
            }

            // Destroy already created singletons to avoid dangling resources.
            destroyBeans();

            // Reset 'active' flag.
            cancelRefresh(ex);

            // Propagate exception to caller.
            throw ex;
        }

        finally {
            // Reset common introspection caches in Spring's core, since we
            // might not ever need metadata for singleton beans anymore...
            resetCommonCaches();
        }
    }
}
```



```java
		//13.ä»iocå®¹å™¨ä¸­è·å–æ‰€æœ‰çš„ApplicationRunnerå’ŒCommandLineRunnerè¿›è¡Œå›è°ƒ
Â Â Â Â Â Â  Â //14.ApplicationRunnerå…ˆå›è°ƒï¼ŒCommandLineRunnerå†å›è°ƒ(1.5.9æºç )
/*
 *2.Xç‰ˆæœ¬æ”¹å˜äº†å·²ç»ï¼šåœ¨åè¾¹å›è°ƒ
 */
        afterRefresh(context, applicationArguments);
       
```





```java
		 stopWatch.stop();
        if (this.logStartupInfo) {
            new StartupInfoLogger(this.mainApplicationClass)
                .logStarted(getApplicationLog(), stopWatch);
        }
		//finish(1.5.9) æ”¹ä¸ºstarted()
        listeners.started(context);
		//å›è°ƒ ApplicationRunnerå…ˆå›è°ƒï¼ŒCommandLineRunnerå†å›è°ƒ
        callRunners(context, applicationArguments);
    }
    catch (Throwable ex) {
        handleRunFailure(context, ex, exceptionReporters, listeners);
        throw new IllegalStateException(ex);
    }

    ğŸ‘‡
```

--callRunners()æ–¹æ³•

```java
private void callRunners(ApplicationContext context, ApplicationArguments args) {
		List<Object> runners = new ArrayList<>();
		runners.addAll(context.getBeansOfType(ApplicationRunner.class).values());
		runners.addAll(context.getBeansOfType(CommandLineRunner.class).values());
		AnnotationAwareOrderComparator.sort(runners);
		for (Object runner : new LinkedHashSet<>(runners)) {
			if (runner instanceof ApplicationRunner) {
				callRunner((ApplicationRunner) runner, args);
			}
			if (runner instanceof CommandLineRunner) {
				callRunner((CommandLineRunner) runner, args);
			}
		}
	}
```



```java
try {	
        //springboot 2.x å¤šäº†ä¸€ä¸ªå›è°ƒlistenersçš„running()æ–¹æ³•
        listeners.running(context);
    }
    catch (Throwable ex) {
        handleRunFailure(context, ex, exceptionReporters, null);
        throw new IllegalStateException(ex);
    }
    //æ‰€æœ‰çš„listenerså›è°ƒå®Œæ¯•
    //15.æ•´ä¸ªSpringBootåº”ç”¨å¯åŠ¨å®Œæˆä»¥åè¿”å›å¯åŠ¨çš„iocå®¹å™¨ï¼›
    return context;
}
```



### äº”ã€è‡ªå®šä¹‰starter

è‡ªå®šä¹‰starterçš„ä¸€äº›é—®é¢˜ï¼š

â€‹	1ã€è¿™ä¸ªåœºæ™¯éœ€è¦ä½¿ç”¨åˆ°çš„ä¾èµ–æ˜¯ä»€ä¹ˆï¼Ÿ

â€‹	2ã€å¦‚ä½•ç¼–å†™è‡ªåŠ¨é…ç½®

```java
@Configuration //æŒ‡å®šè¿™ä¸ªç±»æ˜¯ä¸€ä¸ªé…ç½®ç±»
@ConditionalOnXXXÂ Â //åœ¨æŒ‡å®šæ¡ä»¶æˆç«‹çš„æƒ…å†µä¸‹è‡ªåŠ¨é…ç½®ç±»ç”Ÿæ•ˆ
@AutoConfigureAfterÂ Â //æŒ‡å®šè‡ªåŠ¨é…ç½®ç±»çš„é¡ºåº
@BeanÂ Â //ç»™å®¹å™¨ä¸­æ·»åŠ ç»„ä»¶
@ConfigurationPropertieç»“åˆç›¸å…³xxxPropertiesç±»æ¥ç»‘å®šç›¸å…³çš„é…ç½®
@EnableConfigurationPropertiesÂ //è®©xxxPropertiesç”Ÿæ•ˆåŠ å…¥åˆ°å®¹å™¨ä¸­
è‡ªåŠ¨é…ç½®ç±»è¦èƒ½åŠ è½½
å°†éœ€è¦å¯åŠ¨å°±åŠ è½½çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œé…ç½®åœ¨METAâ€INF/spring.factories
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\
org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\
```

3ã€æ¨¡å¼ï¼š
å¯åŠ¨å™¨åªç”¨æ¥åšä¾èµ–å¯¼å…¥ï¼›
ä¸“é—¨æ¥å†™ä¸€ä¸ªè‡ªåŠ¨é…ç½®æ¨¡å—ï¼›
å¯åŠ¨å™¨ä¾èµ–è‡ªåŠ¨é…ç½®ï¼›åˆ«äººåªéœ€è¦å¼•å…¥å¯åŠ¨å™¨ï¼ˆstarterï¼‰
mybatis-spring-boot-starterï¼›è‡ªå®šä¹‰å¯åŠ¨å™¨å-spring-boot-starterã€€

4.æ­¥éª¤

4.1åˆ›å»ºstarter(æ™®é€šmavenå·¥ç¨‹)

pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 			http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.atguigu.starter</groupId>
    <artifactId>atguigu-spring-boot-starter</artifactId>
    <version>1.0-SNAPSHOT</version>
    <!--å¯åŠ¨å™¨-->
    <dependencies>
        <!--å¼•å…¥è‡ªåŠ¨é…ç½®-->
        <dependency>
            <groupId>com.atguigu.starter</groupId>
            <artifactId>atguigu-spring-boot-autoconfigurer</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
    </dependencies>
</project>
```

4.2åˆ›å»ºspring-bootåŸºç¡€å·¥ç¨‹ --atguigu-spring-boot-autoconfigurer

pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.1.1.RELEASE</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.atguigu.starter</groupId>
	<artifactId>atguigu-spring-boot-autoconfigurer</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>atguigu-spring-boot-autoconfigurer</name>
	<description>Demo project for Spring Boot</description>

	<properties>
		<java.version>1.8</java.version>
	</properties>

	<dependencies>
		<!--å¼•å…¥springboot starter:æ‰€æœ‰starterçš„åŸºæœ¬é…ç½®-->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter</artifactId>
		</dependency>
		<!--lombok-->
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
		</dependency>
	</dependencies>
</project>

```

4.3 åˆ›å»º helloService ç»„ä»¶ å¼•å…¥äº†helloProperties

```java
package com.atguigu.starter;

import lombok.Data;

/**
 * @author hike97 è¨±ã›ã€€ã‚µã‚¹ã‚±ã€€ã“ã‚Œã§æœ€å¾Œã 
 * @create 2019-01-02 16:25
 * @desc
 **/
@Data
public class HelloService {

    private HelloProperties properties;

    public String sayHello(String msg){

        return properties.getPrefix ()+":"+msg+":"+properties.getSuffix ();
    }
}
ğŸ‘‡
```

```java
package com.atguigu.starter;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * @author hike97 è¨±ã›ã€€ã‚µã‚¹ã‚±ã€€ã“ã‚Œã§æœ€å¾Œã 
 * @create 2019-01-02 16:26
 * @desc
 **/
@ConfigurationProperties(prefix = "spring.hello")
@Data
public class HelloProperties {

	private String prefix;

	private String suffix;


}

```

4.4åˆ›å»ºè‡ªåŠ¨è£…é…ç±»HelloServiceAutoConfiguration

```java
package com.atguigu.starter;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * @author hike97 è¨±ã›ã€€ã‚µã‚¹ã‚±ã€€ã“ã‚Œã§æœ€å¾Œã 
 * @create 2019-01-02 16:36
 * @desc
 **/
@Configuration
@ConditionalOnWebApplication//webç¯å¢ƒä¸‹æœ‰æ•ˆ
@EnableConfigurationProperties(HelloProperties.class)
public class HelloServiceAutoConfiguration {

	@Autowired
	HelloProperties helloProperties;

	@Bean
	public HelloService helloService(){
		HelloService service = new HelloService ();
		service.setProperties (helloProperties);
		return service;
	}
}

```

META-INF/spring.factories

```properties
# Auto Configure
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
com.atguigu.starter.HelloServiceAutoConfiguration
```

mavenæ“ä½œï¼šæ‰“åŒ…autoconfigures  æ‰“åŒ…starters

åº”ç”¨ï¼šåœ¨springboot web é¡¹ç›®ä¸­æ·»åŠ è‡ªå®šä¹‰starters ä¾èµ–

```xml
<dependency>
    <groupId>com.atguigu.starter</groupId>
    <artifactId>atguigu-spring-boot-starter</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

åœ¨æ§åˆ¶å±‚ å¼•å…¥ service

```java
package com.haiyuanzi.springboot.code.controller;

import com.atguigu.starter.HelloService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * @author hike97 è¨±ã›ã€€ã‚µã‚¹ã‚±ã€€ã“ã‚Œã§æœ€å¾Œã 
 * @create 2019-01-02 16:46
 * @desc
 **/
@RestController
public class TestStartController {

	@Autowired
	HelloService helloService;

	@GetMapping(value = "/hello" ,produces="text/plain;charset=UTF-8")
	public String sayHello(){

		return helloService.sayHello ("æ±‰æ˜­çƒˆå¼Ÿ");
	}

}
```

åœ¨é…ç½®æ–‡ä»¶ä¸­å¼•ç”¨properties

```properties
server.port=8090
spring.hello.prefix="å°æŸæ ·"
spring.hello.suffix="èœ"
```

æ•ˆæœå¦‚ä¸‹

![1546494909132](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1546494909132.png)